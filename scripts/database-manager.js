#!/usr/bin/env node

/**
 * Script para gerenciar o banco de dados SMM Panel
 * Funcionalidades:
 * 1. Visualizar todo o banco de dados
 * 2. Definir usu√°rio como admin
 * 3. Executar comandos SQL personalizados
 */

const { createClient } = require('@supabase/supabase-js');
const readline = require('readline');

// Configura√ß√£o do Supabase
const SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL || 'https://xpklpweyvwviuiqzjgwe.supabase.co';
const SUPABASE_SERVICE_ROLE_KEY = process.env.SUPABASE_SERVICE_ROLE_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhwa2xwd2V5dnd2aXVpcXpqZ3dlIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NTU2NTE3OSwiZXhwIjoyMDcxMTQxMTc5fQ.7adnyvvwEWyAzYXHWyF7n9SEfdTrxZHcKlSKTJ7gQaQ';

// Criar cliente Supabase com service role key (acesso total)
const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY);

// Interface de linha de comando
const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout
});

// Fun√ß√£o para fazer perguntas
function question(query) {
  return new Promise((resolve) => {
    rl.question(query, resolve);
  });
}

// Fun√ß√£o para visualizar todo o banco de dados
async function viewDatabase() {
  console.log('\nüîç Visualizando todo o banco de dados...\n');
  
  try {
    // 1. Verificar usu√°rios
    console.log('üìä USU√ÅRIOS:');
    const { data: users, error: usersError } = await supabase
      .from('users')
      .select('*')
      .order('created_at', { ascending: false });
    
    if (usersError) throw usersError;
    
    if (users && users.length > 0) {
      users.forEach(user => {
        console.log(`  - ${user.email} (${user.role}) - Status: ${user.status} - Saldo: R$ ${user.balance}`);
      });
    } else {
      console.log('  Nenhum usu√°rio encontrado');
    }
    
    // 2. Verificar categorias
    console.log('\nüìÇ CATEGORIAS:');
    const { data: categories, error: categoriesError } = await supabase
      .from('categories')
      .select('*')
      .order('sort_order', { ascending: true });
    
    if (categoriesError) throw categoriesError;
    
    if (categories && categories.length > 0) {
      categories.forEach(category => {
        console.log(`  - ${category.name} (${category.is_active ? 'Ativo' : 'Inativo'})`);
      });
    } else {
      console.log('  Nenhuma categoria encontrada');
    }
    
    // 3. Verificar servi√ßos
    console.log('\nüõ†Ô∏è SERVI√áOS:');
    const { data: services, error: servicesError } = await supabase
      .from('services')
      .select(`
        *,
        categories(name)
      `)
      .order('created_at', { ascending: false });
    
    if (servicesError) throw servicesError;
    
    if (services && services.length > 0) {
      services.forEach(service => {
        const categoryName = service.categories ? service.categories.name : 'Sem categoria';
        console.log(`  - ${service.name} (${categoryName}) - Provider: ${service.provider} - R$ ${service.rate}`);
      });
    } else {
      console.log('  Nenhum servi√ßo encontrado');
    }
    
    // 4. Verificar pedidos
    console.log('\nüìã PEDIDOS:');
    const { data: orders, error: ordersError } = await supabase
      .from('orders')
      .select(`
        *,
        users(email),
        services(name)
      `)
      .order('created_at', { ascending: false })
      .limit(10);
    
    if (ordersError) throw ordersError;
    
    if (orders && orders.length > 0) {
      orders.forEach(order => {
        const userEmail = order.users ? order.users.email : 'Usu√°rio n√£o encontrado';
        const serviceName = order.services ? order.services.name : 'Servi√ßo n√£o encontrado';
        console.log(`  - Pedido ${order.id.slice(0, 8)} - ${userEmail} - ${serviceName} - Status: ${order.status}`);
      });
    } else {
      console.log('  Nenhum pedido encontrado');
    }
    
    // 5. Verificar transa√ß√µes
    console.log('\nüí∞ TRANSA√á√ïES:');
    const { data: transactions, error: transactionsError } = await supabase
      .from('transactions')
      .select(`
        *,
        users(email)
      `)
      .order('created_at', { ascending: false })
      .limit(10);
    
    if (transactionsError) throw transactionsError;
    
    if (transactions && transactions.length > 0) {
      transactions.forEach(transaction => {
        const userEmail = transaction.users ? transaction.users.email : 'Usu√°rio n√£o encontrado';
        console.log(`  - ${transaction.type} - ${userEmail} - R$ ${transaction.amount} - ${transaction.description || 'Sem descri√ß√£o'}`);
      });
    } else {
      console.log('  Nenhuma transa√ß√£o encontrada');
    }
    
    // 6. Estat√≠sticas gerais
    console.log('\nüìà ESTAT√çSTICAS GERAIS:');
    const userCount = users ? users.length : 0;
    const categoryCount = categories ? categories.length : 0;
    const serviceCount = services ? services.length : 0;
    const orderCount = orders ? orders.length : 0;
    const transactionCount = transactions ? transactions.length : 0;
    
    console.log(`  - Total de usu√°rios: ${userCount}`);
    console.log(`  - Total de categorias: ${categoryCount}`);
    console.log(`  - Total de servi√ßos: ${serviceCount}`);
    console.log(`  - Total de pedidos: ${orderCount}`);
    console.log(`  - Total de transa√ß√µes: ${transactionCount}`);
    
    // 7. Usu√°rios por role
    if (users && users.length > 0) {
      const roleStats = users.reduce((acc, user) => {
        acc[user.role] = (acc[user.role] || 0) + 1;
        return acc;
      }, {});
      
      console.log('\nüë• USU√ÅRIOS POR ROLE:');
      Object.entries(roleStats).forEach(([role, count]) => {
        console.log(`  - ${role}: ${count}`);
      });
    }
    
  } catch (error) {
    console.error('‚ùå Erro ao visualizar banco de dados:', error.message);
  }
}

// Fun√ß√£o para definir usu√°rio como admin
async function setUserAsAdmin(email) {
  console.log(`\nüëë Definindo usu√°rio ${email} como admin...\n`);
  
  try {
    // 1. Verificar se o usu√°rio existe
    const { data: existingUser, error: findError } = await supabase
      .from('users')
      .select('*')
      .eq('email', email)
      .single();
    
    if (findError) {
      if (findError.code === 'PGRST116') {
        console.log(`‚ùå Usu√°rio ${email} n√£o encontrado no banco de dados.`);
        console.log('üí° O usu√°rio deve ser criado primeiro atrav√©s do sistema de autentica√ß√£o.');
        return;
      }
      throw findError;
    }
    
    console.log(`‚úÖ Usu√°rio encontrado: ${existingUser.email} (Role atual: ${existingUser.role})`);
    
    // 2. Atualizar para admin
    const { data: updatedUser, error: updateError } = await supabase
      .from('users')
      .update({ 
        role: 'admin',
        updated_at: new Date().toISOString()
      })
      .eq('email', email)
      .select()
      .single();
    
    if (updateError) throw updateError;
    
    console.log(`üéâ Usu√°rio ${email} foi definido como admin com sucesso!`);
    console.log(`   - Role: ${updatedUser.role}`);
    console.log(`   - Atualizado em: ${updatedUser.updated_at}`);
    
    // 3. Verificar todos os admins
    const { data: admins, error: adminsError } = await supabase
      .from('users')
      .select('email, role, created_at')
      .eq('role', 'admin')
      .order('created_at', { ascending: true });
    
    if (adminsError) throw adminsError;
    
    console.log('\nüëë USU√ÅRIOS ADMIN NO SISTEMA:');
    admins.forEach(admin => {
      console.log(`  - ${admin.email} (desde ${new Date(admin.created_at).toLocaleDateString('pt-BR')})`);
    });
    
  } catch (error) {
    console.error('‚ùå Erro ao definir usu√°rio como admin:', error.message);
  }
}

// Fun√ß√£o para executar comando SQL personalizado
async function executeCustomSQL(sql) {
  console.log(`\nüîß Executando comando SQL personalizado...\n`);
  console.log(`SQL: ${sql}\n`);
  
  try {
    // Nota: Para comandos SQL complexos, voc√™ precisar√° usar o cliente PostgreSQL diretamente
    // Este √© um exemplo b√°sico usando as fun√ß√µes do Supabase
    console.log('‚ö†Ô∏è  Para comandos SQL complexos, use o script SQL diretamente no banco de dados.');
    console.log('üí° Use os arquivos: scripts/03-view-database.sql e scripts/04-set-admin-user.sql');
    
  } catch (error) {
    console.error('‚ùå Erro ao executar comando SQL:', error.message);
  }
}

// Fun√ß√£o principal do menu
async function main() {
  console.log('üöÄ GERENCIADOR DE BANCO DE DADOS SMM PANEL');
  console.log('=============================================\n');
  
  while (true) {
    console.log('\nEscolha uma op√ß√£o:');
    console.log('1. üîç Visualizar todo o banco de dados');
    console.log('2. üëë Definir usu√°rio como admin');
    console.log('3. üîß Executar comando SQL personalizado');
    console.log('4. ‚ùå Sair');
    
    const choice = await question('\nDigite sua escolha (1-4): ');
    
    switch (choice.trim()) {
      case '1':
        await viewDatabase();
        break;
        
      case '2':
        const email = await question('\nDigite o email do usu√°rio: ');
        if (email.trim()) {
          await setUserAsAdmin(email.trim());
        } else {
          console.log('‚ùå Email n√£o pode estar vazio.');
        }
        break;
        
      case '3':
        const sql = await question('\nDigite o comando SQL: ');
        if (sql.trim()) {
          await executeCustomSQL(sql.trim());
        } else {
          console.log('‚ùå Comando SQL n√£o pode estar vazio.');
        }
        break;
        
      case '4':
        console.log('\nüëã At√© logo!');
        rl.close();
        process.exit(0);
        break;
        
      default:
        console.log('‚ùå Op√ß√£o inv√°lida. Tente novamente.');
    }
  }
}

// Verificar se as vari√°veis de ambiente est√£o configuradas
if (!SUPABASE_URL || !SUPABASE_SERVICE_ROLE_KEY) {
  console.error('‚ùå Erro: Vari√°veis de ambiente do Supabase n√£o configuradas.');
  console.error('üí° Configure NEXT_PUBLIC_SUPABASE_URL e SUPABASE_SERVICE_ROLE_KEY no arquivo .env');
  process.exit(1);
}

// Executar o programa
main().catch(error => {
  console.error('‚ùå Erro fatal:', error);
  process.exit(1);
}); 